---
title: "What distribution best describes emperical fish species size distributions?"
author: "Freddie Heather, Shane Richards, Asta Audzijonyte"
execute: 
  comment: false
  warning: false
  error: false
  message: false 
  
---

```{r setup, include = FALSE}
# 
# knitr::opts_chunk$set(
#   comment = FALSE, 
#   warning = FALSE, 
#   error   = FALSE, 
#   message = FALSE
# )


if(!dir.exists("output")) dir.create("output")
if(!dir.exists("output/model_fits")) dir.create("output/model_fits")
if(!dir.exists("output/model_plots")) dir.create("output/model_plots")
if(!dir.exists("output/data_figs")) dir.create("output/data_figs")

rerun_models  <- FALSE # will take a while
rerun_figures <- FALSE

overwrite_smallmodels <- TRUE
overwrite_smallplots  <- TRUE
overwrite_largemodels <- FALSE
overwrite_largeplots  <- FALSE


```

# Setup

```{r packages}

library(readr)
library(dplyr)
library(ggplot2)
library(arrow)
library(rstan)
library(tidyr)
library(tidybayes, include.only = c("spread_draws"))
library(cowplot)
library(stringr)
library(rlang)
library(posterior)
library(fitdistrplus, include.only = "fitdist")
library(purrr)
library(patchwork)
library(scales)


rstan_options(auto_write = TRUE) # avoid recompilation of stan files

```

## Data import

```{r data-import}

data_obs   <- read_parquet("input/data/data_obs_cleaned.parquet")
data_survs <- read_parquet("input/data/survey_list_m1_aus.parquet")

rls_bin_breaks <- 
  data_obs %>% 
  pull(size_class) %>% 
  unique() %>% 
  sort()

rls_bin_table <-
  tibble(size_class = c(0, rls_bin_breaks, 500)) %>% 
  mutate(
    size_indx  = 0:(length(size_class)-1),
    size_min = (size_class + lag(size_class))/2,
    size_max = lead(size_min)
  ) %>% 
  filter(size_class %in% c(rls_bin_breaks, 500))

species_list <- data_obs %>% pull(species_name) %>% unique()

species_indx_table <- 
  tibble(
    species_name = species_list, 
    species_indx = 1:length(species_list))

if(!file.exists("input/data/data_obs_cleaned_sample.parquet")){
  # random 20 species
  set.seed(1)
  random_species <- 
    tibble(
      species_name = sample(unique(data_obs$species_name), 20), 
      species_indx = 1:20)
  
  data_obs %>% 
    filter(species_name %in% random_species$species_name) %>% 
    left_join(random_species, by = join_by(species_name)) %>% 
    write_parquet("data/data_obs_cleaned_sample.parquet")
  
}

data_obs_sample <- read_parquet("input/data/data_obs_cleaned_sample.parquet")

```

## Data wrangling

```{r data-wrangling}

data_obs_count_allspp <- 
  data_obs %>% 
  count(species_name, size_class) %>% 
  left_join(species_indx_table, by = join_by(species_name)) %>% 
  left_join(rls_bin_table, by = join_by(size_class)) %>% 
  add_count(species_indx, wt = n, name = "totaln_spp") %>% 
  arrange(species_indx, size_indx) %>%
  mutate(p = n/totaln_spp) %>% 
  mutate(row = 1:n()) %>% 
  mutate(min_row = min(row), 
         max_row = max(row),
         .by = species_indx) 

data_obs_count_allspp_byspp <-
  data_obs_count_allspp %>% 
  dplyr::select(species_indx, 
                totaln_spp, 
                min_row, 
                max_row) %>% 
  distinct() %>% 
  arrange(species_indx)


data_obs_count_20spp <- 
  data_obs_sample %>% 
  count(species_name, species_indx, size_class) %>% 
  left_join(rls_bin_table, by = join_by(size_class)) %>% 
  add_count(species_indx, wt = n, name = "totaln_spp") %>% 
  arrange(species_indx, size_indx) %>%
  mutate(p = n/totaln_spp) %>% 
  mutate(row = 1:n()) %>% 
  mutate(min_row = min(row), 
         max_row = max(row),
         .by = species_indx) 

data_obs_count_20spp_byspp <-
  data_obs_count_20spp %>% 
  dplyr::select(species_indx, 
                totaln_spp, 
                min_row, 
                max_row) %>% 
  distinct() %>% 
  arrange(species_indx)


# Population level, not species level 
gridcells <-
  data_survs %>% 
  mutate(lat_grid = round(latitude), 
         lon_grid = round(longitude), 
         lat_lon = paste(lat_grid, lon_grid, sep = "_")) %>% 
  select(survey_id, lat_lon)


data_obs_poplvl <- 
  data_obs %>% 
  left_join(gridcells) %>% 
  mutate(species_name = paste(species_name, lat_lon, sep = "__")) %>% 
  count(species_name, size_class) %>% 
  add_count(species_name, name = "n_bins") %>% 
  add_count(species_name, wt = n, name = "n_total") %>% 
  filter(n_bins >= 4, 
         n_total >= 200) %>% 
  filter(str_detect(species_name, "Abudefduf bengalensis"))

species_indx_table_poplvl <- 
  tibble(
    species_name = unique(data_obs_poplvl$species_name), 
    species_indx = 1:length(unique(data_obs_poplvl$species_name))
  )

data_obs_count_poplvl <- 
  data_obs_poplvl %>% 
  left_join(species_indx_table_poplvl, by = join_by(species_name)) %>% 
  left_join(rls_bin_table, by = join_by(size_class)) %>% 
  add_count(species_indx, wt = n, name = "totaln_spp") %>% 
  arrange(species_indx, size_indx) %>%
  mutate(p = n/totaln_spp) %>% 
  mutate(row = 1:n()) %>% 
  mutate(min_row = min(row), 
         max_row = max(row),
         .by = species_indx)

data_obs_count_poplvl_byspp <-
  data_obs_count_poplvl %>% 
  dplyr::select(species_indx, 
                totaln_spp, 
                min_row, 
                max_row) %>% 
  distinct() %>% 
  arrange(species_indx)


```


## Data simulation

```{r data-simulation}

# set number of simulated species
sim_n_spp <- 20
sim_n_reps <- 1000
set.seed(1)

rls_bin <- function(size) {
  rls_bin_table$size_class[.bincode(size, breaks = c(0, rls_bin_table$size_max))]
}

is_odd <- function(x) ((x/2) %% 1) == 0.5

data_out <- tibble()

for(i in 1:sim_n_spp){
  
  # is odd number?
  if(is_odd(i)) {
    xx <- 
      tibble(num = 1:sim_n_reps) %>% 
      mutate(mean = rlnorm(1, 2.45, 0.78), 
             sd =  0.09687 + mean*0.33557) %>% 
      mutate(size_class_raw = rnorm(n = sim_n_reps, 
                                    mean = mean, 
                                    sd = sd)) %>% 
      mutate(species_indx = i) %>% 
      mutate(species_name = paste0("spp_", species_indx)) %>% 
      filter(size_class_raw > 1.25) %>% 
      mutate(size_class = rls_bin(size_class_raw)) %>% 
      dplyr::select(-num)
  } else {
    xx <- 
      tibble(num = 1:sim_n_reps) %>% 
      mutate(mean = rlnorm(1, 1.5, 0.1), 
             sd =  rlnorm(1, 0.5, 0.1)) %>% 
      mutate(size_class_raw = rlnorm(n = sim_n_reps, 
                                     meanlog = log(mean), 
                                     sdlog = log(sd))) %>% 
      mutate(species_indx = i) %>% 
      mutate(species_name = paste0("spp_", species_indx)) %>% 
      filter(size_class_raw > 1.25) %>% 
      mutate(size_class = rls_bin(size_class_raw)) %>% 
      dplyr::select(-num)
  }
  
  data_out <- bind_rows(data_out, xx)
}

data_sim <- 
  data_out %>% 
  left_join(rls_bin_table %>% dplyr::select(size_class, size_indx),
            by = join_by(size_class)) 

# For binned simulated data
data_sim_count <-
  data_sim %>% 
  count(species_indx, 
        size_class, 
        size_indx) %>% 
  left_join(rls_bin_table, 
            by = join_by(size_class, size_indx)) %>% 
  add_count(species_indx, wt = n, name = "totaln_spp") %>% 
  mutate(p = n/totaln_spp) %>% 
  mutate(row = 1:n()) %>% 
  mutate(min_row = min(row), 
         max_row = max(row),
         .by = species_indx)

data_sim_byspp <-
  data_sim_count %>% 
  dplyr::select(species_indx, 
                totaln_spp, 
                min_row, 
                max_row) %>% 
  distinct()

```

## Data visualisation

### Real data

```{r datavis-realdata}


if(!file.exists("output/data_figs/ssd_obs_20spp.png") | rerun_figures){
  
  p <-
    data_obs_sample %>% 
    count(species_name, size_class) %>% 
    ggplot() +
    geom_point(mapping = aes(x = size_class, y = n)) +
    geom_line(mapping = aes(x = size_class, y = n)) +
    facet_wrap( ~ species_name, scales = "free") +
    labs(x = "Fish length (cm)",  
         y = "Fish abundance") +
    theme_bw() 
  
  save_plot(plot = p, 
            filename = "output/data_figs/ssd_obs_20spp.png", 
            base_height = 8)
  
}

if(!file.exists("output/data_figs/ssd_obs_20spp_log.png") | rerun_figures){
  
  p <- 
    data_obs_sample %>% 
    count(species_name, size_class) %>% 
    ggplot() +
    geom_point(mapping = aes(x = size_class, y = n)) +
    geom_line(mapping = aes(x = size_class, y = n)) +
    facet_wrap( ~ species_name, scales = "free") +
    scale_y_log10() +
    scale_x_log10() +
    labs(x = "Log Fish length (cm)",  
         y = "Log Fish abundance") +
    theme_bw()
  
  save_plot(plot = p, 
            filename = "output/data_figs/ssd_obs_20spp_log.png", 
            base_height = 8)
  
}

```

### Simulated data

```{r datavis-simulateddata}

if(!file.exists("output/data_figs/ssd_sim_20spp.png") | rerun_figures){
  
  p <-
    data_sim %>% 
    count(species_indx, size_class) %>% 
    ggplot() +
    geom_point(mapping = aes(x = size_class, y = n)) +
    geom_line(mapping = aes(x = size_class, y = n)) +
    facet_wrap( ~ species_indx, scales = "free") +
    labs(x = "Fish length (cm)",  
         y = "Fish abundance") +
    theme_bw() 
  
  save_plot(plot = p, 
            filename = "output/data_figs/ssd_sim_20spp.png", 
            base_height = 8)
  
}

if(!file.exists("output/data_figs/ssd_sim_20spp_log.png") | rerun_figures){
  
  p <- 
    data_sim %>% 
    count(species_indx, size_class) %>% 
    ggplot() +
    geom_point(mapping = aes(x = size_class, y = n)) +
    geom_line(mapping = aes(x = size_class, y = n)) +
    facet_wrap( ~ species_indx, scales = "free") +
    scale_y_log10() +
    scale_x_log10() +
    labs(x = "Log Fish length (cm)",  
         y = "Log Fish abundance") +
    theme_bw()
  
  save_plot(plot = p, 
            filename = "output/data_figs/ssd_sim_20spp_log.png", 
            base_height = 8)
  
}


```


# Bayesian modelling

## Outline of models

I want to create the following models:

| Model Name | Stan     | Data | nspp   | Data type | Distribution | Overdispersion? | Bin correction? | par1 (location) | par2 (variance)     |
|--------|--------|--------|--------|--------|--------|--------|--------|--------|--------|
| model_01   | model_01 | sim  | 20     | cont      | norm         | No              | No              | per species     | per species         |
| model_02   | model_02 | sim  | 20     | cont      | lnorm        | No              | No              | per species     | per species         |
| model_03   | model_03 | sim  | 20     | bin       | norm         | No              | No              | per species     | per species         |
| model_04   | model_04 | sim  | 20     | bin       | lnorm        | No              | No              | per species     | per species         |
| model_05   | model_03 | real | 20/774 | bin       | norm         | No              | No              | per species     | per species         |
| model_06   | model_04 | real | 20/774 | bin       | lnorm        | No              | No              | per species     | per species         |
| model_07   | model_07 | real | 20/774 | bin       | norm         | No              | No              | per species     | predicted from par1 |
| model_08   | model_08 | real | 20/774 | bin       | lnorm        | No              | No              | per species     | predicted from par1 |
| model_09   |          | real |        | bin       | norm         | No              | Yes             | per species     | per species         |
| model_10   |          | real |        | bin       | lnorm        | No              | Yes             | per species     | per species         |
| model_11   |          | real |        | bin       | norm         | No              | Yes             | per species     | predicted from par1 |
| model_12   |          | real |        | bin       | lnorm        | No              | Yes             | per species     | predicted from par1 |
| model_13   |          | real |        | bin       | norm & lnorm | No              | Yes             | per species     | per species         |
| model_14   |          | real |        | bin       | norm & lnorm | No              | Yes             | per species     | predicted from par1 |


```{r}

mods_summary <-
  tribble(
    ~model_name, ~stan_file, ~data, ~data_type, ~data_source, ~varname, ~n_species, ~distribution, ~bin_correction, ~location_par, ~variance_par,
    "mod_01", "mod_01", "sim", "continuous", "data_sim", "size_class_raw", 20, "norm", "No", "per species", "per species",
    "mod_02", "mod_02",  "sim", "continuous", "data_sim", "size_class_raw", 20, "lnorm", "No", "per species", "per species",
    "mod_03", "mod_03", "sim", "binned",  "data_sim_count", "size_class", 20, "norm", "No", "per species", "per species",
    "mod_04", "mod_04",  "sim", "binned", "data_sim_count", "size_class", 20, "lnorm", "No", "per species", "per species",
    "mod_05", "mod_03", "real", "binned",  "data_obs_count_20spp", "size_class", 20, "norm", "No", "per species", "per species",
    "mod_06", "mod_04",  "real", "binned", "data_obs_count_20spp", "size_class", 20, "lnorm", "No", "per species", "per species",
    "mod_05_allspp", "mod_03", "real", "binned",  "data_obs_count_allspp", "size_class", 774, "norm", "No", "per species", "per species",
    "mod_06_allspp", "mod_04",  "real", "binned", "data_obs_count_allspp", "size_class", 774, "lnorm", "No", "per species", "per species",
    "mod_07", "mod_07", "real", "binned",  "data_obs_count_20spp", "size_class", 20, "norm", "No", "per species", "predicted from par1",
    "mod_08", "mod_08",  "real", "binned", "data_obs_count_20spp", "size_class", 20, "lnorm", "No", "per species", "predicted from par1",
    "mod_07_allspp", "mod_07", "real", "binned",  "data_obs_count_allspp", "size_class", 774, "norm", "No", "per species", "predicted from par1",
    "mod_08_allspp", "mod_08",  "real", "binned", "data_obs_count_allspp", "size_class", 774, "lnorm", "No", "per species", "predicted from par1",
    "mod_09", "mod_09", "real", "binned",  "data_obs_count_20spp", "size_class", 20, "norm", "Yes", "per species", "per species",
    "mod_10", "mod_10",  "real", "binned", "data_obs_count_20spp", "size_class", 20, "lnorm", "Yes", "per species", "per species",
    "mod_09_allspp", "mod_09", "real", "binned",  "data_obs_count_allspp", "size_class", 774, "norm", "Yes", "per species", "per species",
    "mod_10_allspp", "mod_10",  "real", "binned", "data_obs_count_allspp", "size_class", 774, "lnorm", "Yes", "per species", "per species",
    "mod_11", "mod_11", "real", "binned",  "data_obs_count_20spp", "size_class", 20, "norm", "Yes", "per species", "predicted from par1",
    "mod_12", "mod_12",  "real", "binned", "data_obs_count_20spp", "size_class", 20, "lnorm", "Yes", "per species", "predicted from par1",
    "mod_11_allspp", "mod_11", "real", "binned",  "data_obs_count_allspp", "size_class", 774, "norm", "Yes", "per species", "predicted from par1",
    "mod_12_allspp", "mod_12",  "real", "binned", "data_obs_count_allspp", "size_class", 774, "lnorm", "Yes", "per species", "predicted from par1",
    "mod_13", "mod_13",  "real", "binned", "data_obs_count_20spp", "size_class", 20, "norm & lnorm", "Yes", "per species", "per species",
    "mod_13_allspp", "mod_13",  "real", "binned", "data_obs_count_allspp", "size_class", 774, "norm & lnorm", "Yes", "per species", "per species",
    "mod_13_poplvl", "mod_13",  "real", "binned", "data_obs_count_poplvl", "size_class", 774, "norm & lnorm", "Yes", "per species", "per species",
    "mod_14_poplvl", "mod_14",  "real", "binned", "data_obs_count_poplvl", "size_class", 774, "norm & lnorm", "Yes", "per species", "predicted from par1",
  )

```


## Functions

```{r modelling-functions}

# make the stan datalist for models 03 and 04
make_datalist <- function(mod_name){
  
  count_data_name <- 
    case_when(mod_name %in% c("mod_01, mod_02") ~ "data_sim", 
              str_detect(mod_name, "_allspp") ~ "data_count_allspp", 
              str_detect(mod_name, "_poplvl") ~ "data_count_poplvl", 
              TRUE ~ "data_obs_count_20spp")

  spplevel_data_name <- paste0(count_data_name, "_byspp") 
  
  count_data <- get(count_data_name)
  spplevel_data <- get(spplevel_data_name)
  
  list(
    I = nrow(count_data),
    S = max(count_data$species_indx),
    B = max(count_data$size_indx),
    l = rls_bin_table$size_min[1:(max(count_data$size_indx)+1)],
    N_species = spplevel_data$totaln_spp,
    i_min     = spplevel_data$min_row,
    i_max     = spplevel_data$max_row,
    s = count_data$species_indx,
    b = count_data$size_indx,
    n = count_data$n
  )
}

run_stanmod <- function(mod_name, 
                        overwrite = FALSE, 
                        iter = 2000, 
                        warmup = 1500, 
                        chains = 3, 
                        init_r = 2){
  
  mod_fits_filename <- paste0("output/model_fits/", mod_name, ".rds")
  
  if(!file.exists(mod_fits_filename) | overwrite){
    
    stanfile <-
      mods_summary %>% 
      filter(model_name == mod_name)  %>% 
      pull(stan_file) %>% 
      paste0("input/models/", ., ".stan")
    
    datalist <- make_datalist(mod_name)
    
    mod_fit <-
      stan(stanfile,
           data = datalist,
           iter = iter,
           warmup = warmup,
           chains = chains,
           refresh = 500,
           init_r = init_r,
           seed = 1,
           cores = chains,
           save_dso = FALSE
      )
    
    saveRDS(mod_fit, mod_fits_filename)
  } else {
    mod_fit <- readRDS(mod_fits_filename)
  }
  return(mod_fit)
}


run_multiple_mods <- function(integer_vector, 
                              all_species = FALSE, 
                              poplvl = FALSE,
                              overwrite_model = FALSE, 
                              init_r = 2){
  
  integer_vector %>% 
    str_pad(pad = "0", width = 2) %>% 
    paste0("mod_", .) %>% 
    {if(all_species) paste0(., "_allspp") else .} %>% 
    {if(poplvlv) paste0(., "_poplvl") else .} %>% 
    map(run_stanmod, overwrite = overwrite_model, init_r = init_r)
}


plot_multiple_mods <- function(integer_vector, 
                               all_species = FALSE, 
                               poplvl = FALSE,
                               overwrite_plot = FALSE,
                               overwrite_pars = FALSE){
  
  
  integer_vector %>% 
    str_pad(pad = "0", width = 2) %>% 
    paste0("mod_", .) %>% 
    {if(all_species) paste0(., "_allspp") else .} %>% 
    {if(poplvlv) paste0(., "_poplvl") else .} %>% 
    map(plot_mod_fit, 
        overwrite = overwrite_plot, 
        overwrite_pars = overwrite_pars)
}


# extract parameters from a stan model in a tidy way
extract_pars <- function(stan_model, overwrite_pars = TRUE){
  
  pars_filename <- paste0("output/model_pars/", stan_model, ".csv")
  
  if(!file.exists(pars_filename) | overwrite_pars){
    pars_output <- 
      run_stanmod(stan_model, 
                  overwrite = FALSE) %>%
      summarise_draws() %>% 
      mutate(species_indx = str_extract(variable, "(?<=\\[)\\d*(?=\\])") %>% as.numeric()) %>% 
      mutate(parameter = str_remove(variable, "\\[\\d*\\]")) %>% 
      filter(!str_detect(parameter, "ln_")) %>% # transformed from generated quantities
      filter(!str_detect(parameter, "logit_")) %>% # transformed from generated quantities
      filter(parameter != "lp__") %>% 
      dplyr::select(species_indx, 
                    parameter, 
                    median,
                    q5, 
                    q95) %>% 
      drop_na(species_indx) %>% 
      pivot_wider(values_from = median:q95,
                  names_from = parameter) %>% 
      pivot_longer(cols = contains(c("median_", "q5_", "q95_")), 
                   names_to = c("quantile", "parameter"),
                   names_pattern = "(.*?)_(.*)") %>% # non-greedy
      pivot_wider(values_from = value, 
                  names_from = parameter)
    
    write_csv(x = pars_output, file = pars_filename)
  } else {
    pars_output <- read_csv(pars_filename, show_col_types = FALSE)
  }
  return(pars_output)
}


plot_mod_fit <- function(mod_name, overwrite = FALSE, overwrite_pars = FALSE){
  
  mod_row <- mods_summary %>% filter(model_name == mod_name) 
  
  mod_plots_filename <- paste0("output/model_plots/", mod_name, ".png")
  mod_pars <- extract_pars(mod_name, overwrite_pars = overwrite_pars)
  rawdata <- eval(parse(text = mod_row$data_source))
  dist <- mod_row$distribution
  xvar <- mod_row$varname
  data_type <- mod_row$data_type
  all_spp <- str_detect(mod_name, "allspp")
  bin_corr <- str_detect(mod_row$bin_correction, "Yes")
  var_est <- str_detect(mod_row$variance_par, "predicted")
  
  facet_name <- 
    ifelse(
      mod_row$data == "real", 
      "species_name", 
      "species_indx"
    )
  
  subtitle = paste(
    if(all_spp){"774 species, "} else {"20 species, "},
    if(bin_corr){"Corrected for first bin, "} else {"Not corrected for first bin, "},
    if(dist == "norm"){
      if(var_est){"sigma predicted from mu, "} else {"per-species sigma, "}
    } else if(dist == "lnorm") {
      if(var_est){"sdlog predicted from meanlog, "} else {"per-species sdlog, "}
    } else if(dist == "norm & lnorm"){
      if(var_est){"variance pars predicted from location pars, "} else {"per-species variance pars, "}
    },
    if(mod_row$data == "real"){"real data."} else {"simulated data."}
  )
  
  if(!file.exists(mod_plots_filename) | overwrite){
    
    if(data_type == "continuous"){
      mod_plot <- 
        plot_model_continuous(stan_model_pars = mod_pars, 
                              raw_data = rawdata,
                              dist = dist, 
                              xvar = xvar, 
                              facet_var = facet_name, 
                              sub = subtitle)
    }
    
    if(data_type == "binned"){
      mod_plot <- 
        plot_model_binned(stan_model_pars = mod_pars, 
                          raw_data = rawdata,
                          dist = dist, 
                          xvar = xvar, 
                          facet_var = facet_name, 
                          allspp = all_spp, 
                          sub = subtitle)
    }
    
    save_plot(plot = mod_plot, 
              filename = mod_plots_filename, 
              base_height = 8)
  }
  
}


# plot a stan model fit to continuous body size (i.e. simulated data)
plot_model_continuous <- function(stan_model_pars, 
                                  raw_data,  
                                  dist, 
                                  xvar, 
                                  facet_var = "species_indx", 
                                  sub = ""){
  
  
  raw_data %>% 
    full_join(stan_model_pars,
              by = join_by(species_indx),
              multiple = "all")  %>% 
    {if(dist == "norm") mutate(., 
                               fit = dnorm(!!sym(xvar), 
                                           mu, sigma)) else .} %>% 
    {if(dist == "lnorm") mutate(., 
                                fit = dlnorm(!!sym(xvar), 
                                             meanlog, sdlog)) else .} %>%
    dplyr::select(!!sym(facet_var), !!sym(xvar), quantile, fit) %>% 
    pivot_wider(names_from = quantile,
                values_from = fit) %>%
    ggplot() +
    aes(x = !!sym(xvar)) +
    geom_density() +
    geom_line(aes(y = median), 
              col = if(dist == "norm"){"blue"}else{"red"} ,
              alpha = 0.5) +
    geom_ribbon(aes(ymin = q5,
                    ymax = q95),
                fill = if(dist == "norm"){"blue"}else{"red"},
                alpha = 0.5) +
    facet_wrap(as.formula(paste("~", facet_var)), scales = "free")  +
    ggtitle(label = sub,
            subtitle = paste0(dist, " (", if(dist == "norm"){"blue"}else{"red"}, ")"))
  
}

# plot a stan model fit to binned body size (e.g. RLS data)
plot_model_binned <- function(stan_model_pars, 
                              raw_data,  
                              dist, 
                              xvar, 
                              facet_var = "species_indx", 
                              allspp, 
                              sub = ""){
  
  if(dist == "norm & lnorm"){
    
    raw_data %>% 
      full_join(stan_model_pars,
                by = join_by(species_indx),
                multiple = "all")  %>% 
      {if(allspp) filter(., species_indx %in% 1:20) else .} %>% 
      mutate(fit_norm = pnorm(size_max, mu, sigma) -  pnorm(size_min, mu, sigma), 
             fit_lnorm = plnorm(size_max, meanlog, sdlog) - plnorm(size_min, meanlog, sdlog)) %>% 
      dplyr::select(!!sym(facet_var), !!sym(xvar), quantile, p, norm = fit_norm, lnorm = fit_lnorm) %>% 
      pivot_wider(names_from = quantile,
                  values_from = c(norm, lnorm)) %>%
      ggplot() +
      aes(x = !!sym(xvar), 
          y = p) +
      geom_point() +
      geom_line() + 
      geom_point(aes(y = norm_median), 
                 col = "blue",
                 alpha = 0.5) +
      geom_line(aes(y = norm_median), 
                col = "blue",
                alpha = 0.5) +
      geom_ribbon(aes(ymin = norm_q5,
                      ymax = norm_q95),
                  fill = "blue",
                  alpha = 0.5) +
      geom_point(aes(y = lnorm_median), 
                 col = "red",
                 alpha = 0.5) +
      geom_line(aes(y = lnorm_median), 
                col = "red",
                alpha = 0.5) +
      geom_ribbon(aes(ymin = lnorm_q5,
                      ymax = lnorm_q95),
                  fill = "red",
                  alpha = 0.5) +
      facet_wrap(as.formula(paste("~", facet_var)), scales = "free")  +
      ggtitle(label = paste0(dist, " (", if(dist == "norm"){"blue"}else{"red"}, ")"), 
              subtitle = sub)
    
  } else {
    
    xx <- raw_data %>% 
      full_join(stan_model_pars,
                by = join_by(species_indx),
                multiple = "all")  %>% 
      {if(allspp) filter(., species_indx %in% 1:20) else .} %>% 
      {if(dist == "norm") mutate(., 
                                 fit = pnorm(size_max, mu,sigma) -  
                                   pnorm(size_min, mu, sigma)) else .} %>% 
      {if(dist == "lnorm") mutate(., 
                                  fit = plnorm(size_max, meanlog, sdlog) -  
                                    plnorm(size_min, meanlog, sdlog)) else .} %>%
      dplyr::select(!!sym(facet_var), !!sym(xvar), quantile, p, fit) %>% 
      pivot_wider(names_from = quantile,
                  values_from = fit) %>%
      ggplot() +
      aes(x = !!sym(xvar), 
          y = p) +
      geom_point() +
      geom_line() + 
      geom_point(aes(y = median), 
                 col = if(dist == "norm"){"blue"}else{"red"},
                 alpha = 0.5) +
      geom_line(aes(y = median), 
                col = if(dist == "norm"){"blue"}else{"red"},
                alpha = 0.5) +
      geom_ribbon(aes(ymin = q5,
                      ymax = q95),
                  fill = if(dist == "norm"){"blue"}else{"red"},
                  alpha = 0.5) +
      facet_wrap(as.formula(paste("~", facet_var)), scales = "free")  +
      ggtitle(paste0(dist, " (", if(dist == "norm"){"blue"}else{"red"}, ")"), 
              subtitle = sub)
  }
  
}

comparison_plot <- function(mod1, mod2, plot_title = ""){
  
  mod_row1 <- mods_summary %>% filter(model_name == mod1) 
  mod_row2 <- mods_summary %>% filter(model_name == mod2) 
  
  mod_pars1 <- extract_pars(mod1)
  mod_pars2 <- extract_pars(mod2)
  
  rawdata1 <- eval(parse(text = mod_row1$data_source))
  rawdata2 <- eval(parse(text = mod_row2$data_source))
  
  # if(rawdata1 != rawdata2) return("Non-compatable comparison, models must use the same data")
  
  dist1 <- mod_row1$distribution
  dist2 <- mod_row2$distribution
  
  bin_corr1 <- str_detect(mod_row1$bin_correction, "Yes")
  bin_corr2 <- str_detect(mod_row2$bin_correction, "Yes")
  
  get_model_fits <- function(rawdata, mod_pars, dist){
    rawdata %>% 
      arrange(species_indx, size_class) %>% 
      dplyr::select(species_name, species_indx, size_class, size_min, size_max, p) %>% 
      full_join(mod_pars,
                by = join_by(species_indx),
                multiple = "all") %>% 
      {if(dist == "norm") mutate(., fit = pnorm(size_max, mu, sigma) -
                                   pnorm(size_min, mu, sigma)) else .} %>% 
      {if(dist == "lnorm") mutate(.,  fit = plnorm(size_max, meanlog, sdlog) -  
                                    plnorm(size_min, meanlog, sdlog)) else .} %>%
      dplyr::select(species_name, species_indx, size_class, p, quantile, fit) %>% 
      pivot_wider(names_from = quantile,
                  values_from = fit)
  }
  
  mod1_out <- get_model_fits(rawdata1, mod_pars1, dist1)
  mod2_out <- get_model_fits(rawdata2, mod_pars2, dist2)
  
  mod_plot <-
    rawdata1 %>% 
    ggplot() +
    aes(x = size_class, 
        y = p) +
    geom_point() +
    geom_line() + 
    geom_point(aes(y = median), 
               col = if(dist1 == "norm"){"blue"}else{"red"}, 
               alpha = 0.5,
               data = mod1_out) +
    geom_line(aes(y = median), 
              col = if(dist1 == "norm"){"blue"}else{"red"},
              alpha = 0.5,
              lty = if(bin_corr1){1}else{2},
              data = mod1_out) +
    geom_ribbon(aes(ymin = q5,
                    ymax = q95),
                fill = if(dist1 == "norm"){"blue"}else{"red"},
                alpha = 0.5,
                data = mod1_out) +
    geom_point(aes(y = median), 
               col = if(dist2 == "norm"){"blue"}else{"red"}, 
               alpha = 0.5,
               data = mod2_out) +
    geom_line(aes(y = median), 
              col = if(dist2 == "norm"){"blue"}else{"red"}, 
              alpha = 0.5,
              lty = if(bin_corr2){1}else{2},
              data = mod2_out) +
    geom_ribbon(aes(ymin = q5,
                    ymax = q95),
                fill = if(dist2 == "norm"){"blue"}else{"red"}, 
                alpha = 0.5,
                data = mod2_out) +
    facet_wrap(~species_name, scales = "free") +
    ggtitle(label = plot_title, 
            subtitle = "Normal (blue), lognormal (red), bin correction (dotted = no, solid = yes)")
  
  save_plot(plot = mod_plot, 
            filename = paste0("output/model_plots/", mod1, "_vs_", mod2, ".png"), 
            base_height = 8)
}



```


## Models


### Running models

```{r}

run_multiple_mods(1:13, 
                  init_r = 1, 
                  all_species = FALSE,
                  overwrite_model = FALSE)

run_multiple_mods(13, 
                  init_r = 1, 
                  all_species = TRUE,
                  overwrite_model = FALSE)


run_stanmod("mod_13_allspp") %>% traceplot("mu")
run_stanmod("mod_13") %>% traceplot("cv")
run_stanmod("mod_13") %>% traceplot("meanlog")
run_stanmod("mod_13") %>% traceplot("sdlog")

```

### Plot models

```{r}

plot_multiple_mods(integer_vector = 13, 
                   all_species = TRUE,
                   overwrite_plot = TRUE, 
                   overwrite_pars = TRUE)


run_multiple_mods()

extract_pars("mod_13_poplvl", overwrite_pars = FALSE) %>% 
  ggplot(aes(x = cv_N)) +
  geom_density()


run_stanmod("mod_13_allspp") %>% traceplot(pars)

pars <- 
  1:20 %>% 
  # str_pad(width = 2, pad = 0) %>% 
  paste0("mu_N[", ., "]")

```

### Comparing models

```{r}

comparison_plot("mod_05", "mod_06", "norm vs lnorm, variance per species")
comparison_plot("mod_07", "mod_08", "norm vs lnorm, variance estimated")
comparison_plot("mod_09", "mod_10", "norm vs lnorm, variance per species (with bin correction)")
comparison_plot("mod_11", "mod_12", "norm vs lnorm, variance estimated (with bin correction)")
comparison_plot("mod_05", "mod_09", 
                "norm, correction vs no-correction, variance per species (with bin correction)")
comparison_plot("mod_06", "mod_10", 
                "norm, correction vs no-correction, variance per species (with bin correction)")
comparison_plot("mod_07", 
                "mod_11", "norm, correction vs no-correction, variance estimated (with bin correction)")

comparison_plot("mod_05", "mod_07", "norm, variance per species vs estimated")
comparison_plot("mod_06", "mod_08", "lnorm, variance per species vs estimated")
comparison_plot("mod_09", "mod_11", "norm, variance per species vs estimated (with bin correction)")
comparison_plot("mod_10", "mod_12", "lnorm, variance per species vs estimated (with bin correction)")

```

# Further analysis

## Population level

```{r}


xx <- run_stanmod("mod_13_poplvl", overwrite = TRUE)

read_rds("output/model_fits/mod_13_poplvl.rds")

mod_13_poplvl_pars <- 
  extract_pars("mod_13_poplvl", overwrite_pars = TRUE) %>% 
  left_join(species_indx_table_poplvl) %>% 
  rename(species_lat_lon = species_name) %>% 
  mutate(species_name = str_extract(species_lat_lon, ".*(?=__)"), 
         lat = str_extract(species_lat_lon, "(?<=__).*(?=_)") %>% as.numeric(), 
         lon = str_extract(species_lat_lon, "(?<=_)(\\d|-)*$") %>% as.numeric()) %>% 
  left_join(summarise(data_obs_count_allspp, 
                      mean_size = mean(size_class, wt = n), 
                      .by = species_name)) 

raw_data <- 
  data_obs_count_poplvl %>% 
  rename(species_lat_lon = species_name)

stan_model_pars <- mod_13_poplvl_pars
  

raw_data %>% 
  left_join(stan_model_pars,
            multiple = "all")  %>% 
  mutate(fit_norm = pnorm(size_max, mu, sigma) -  pnorm(size_min, mu, sigma), 
         fit_lnorm = plnorm(size_max, meanlog, sdlog) - plnorm(size_min, meanlog, sdlog)) %>% 
  dplyr::select(lat, lon, size_class, quantile, p, norm = fit_norm, lnorm = fit_lnorm) %>% 
  pivot_wider(names_from = quantile,
              values_from = c(norm, lnorm)) %>%
  ggplot() +
  aes(x = size_class, 
      y = p) +
  geom_point() +
  geom_line() + 
  geom_point(aes(y = norm_median), 
             col = "blue",
             alpha = 0.5) +
  geom_line(aes(y = norm_median), 
            col = "blue",
            alpha = 0.5) +
  geom_ribbon(aes(ymin = norm_q5,
                  ymax = norm_q95),
              fill = "blue",
              alpha = 0.5) +
  geom_point(aes(y = lnorm_median), 
             col = "red",
             alpha = 0.5) +
  geom_line(aes(y = lnorm_median), 
            col = "red",
            alpha = 0.5) +
  geom_ribbon(aes(ymin = lnorm_q5,
                  ymax = lnorm_q95),
              fill = "red",
              alpha = 0.5) +
  facet_grid(lon~lat, scales = "free")

```


## Parameter regression

```{r}


# mod_13_fit <- run_stanmod("mod_13_poplvl", overwrite = FALSE)


mod_13_pars %>% 
  filter(quantile == "median") %>% 
  ggplot(aes(x = meanlog) ) +
  geom_density()

mod_13_pars %>% 
  filter(quantile == "median") %>% 
  ggplot(aes(mu, cv)) +
  geom_point()

mod_13_pars %>% 
  filter(quantile == "median") %>% 
  ggplot(aes(meanlog, sdlog)) +
  geom_point()

mod_13_pars_extra <-
  mod_13_pars 

mod_13_pars_extra %>% 
  filter(quantile == "median") %>% 
  filter(species_name == "Abudefduf bengalensis") %>% 
  ggplot(aes(x = mu, 
             y = lat)) +
  geom_point() +
  stat_smooth() 

mod_13_pars_extra %>% 
  filter(quantile == "median") %>% 
  filter(species_name %in% head(species_list, 20)) %>% 
  ggplot(aes(x = lat, 
             y = mu)) +
  geom_point() +
  stat_smooth(method = "lm") +
  facet_wrap(~species_name, scales = "free")

output_table <- tibble()
for(sp in unique(mod_13_pars_extra$species_name)){
  for(par in c("mu", "sigma", "sdlog", "meanlog")){
    
    mod_formula <- as.formula(paste0(par, "~ lat"))
    
    mod_vals <- 
      mod_13_pars_extra %>% 
      filter(quantile == "median") %>% 
      filter(species_name == sp ) %>% 
      lm(mod_formula, data = .) %>% 
      broom::tidy()
    
    output_table <-
      output_table %>% 
      bind_rows(
        tibble(
          species_name = sp, 
          parameter = par,
          slope = mod_vals$estimate[2], 
          intercept = mod_vals$estimate[1],
          slope_p = mod_vals$p.value[2], 
          intercept_p = mod_vals$p.value[1] 
        )
      )
  }
  
}


output_table %>% 
  left_join(summarise(data_obs_count_allspp %>% mutate(species_name =str_extract(species_name, ".*(?=__)")), 
                      mean_size = mean(size_class, wt = n), 
                      .by = species_name)) %>% 
  ggplot(aes(x = mean_size, 
             y = slope)) +
  
  geom_point() + 
  stat_smooth() +
  facet_wrap(~parameter)




compare_pars_plot <- function(norm_mod, lnorm_mod, xlim = c(NA, NA), ylim = c(NA, NA)){
  
  norm_pars <- extract_pars(norm_mod) %>% filter(quantile == "median")
  lnorm_pars <- extract_pars(lnorm_mod) %>% filter(quantile == "median")
  
  norm_lm <- lm(sigma ~ mu, data = norm_pars)
  lnorm_lm <- lm(sdlog ~ meanlog, data = lnorm_pars)
  
  p1 <- 
    mod_05_allspp_pars %>% 
    mutate(fit = predict(norm_lm)) %>% 
    ggplot() +
    aes(
      x = mu, 
      y = sigma
    ) +
    geom_point() +
    geom_line(aes(y = fit)) +
    geom_line(aes(y = fit), 
              col = "blue") +
    stat_smooth(col = "orange") +
    theme_cowplot(20)
  
  p2 <- 
    mod_06_allspp_pars %>% 
    mutate(fit = predict(lnorm_lm)) %>% 
    ggplot() +
    aes(
      x = meanlog, 
      y = sdlog
    ) +
    geom_point() +
    geom_line(aes(y = fit), 
              col = "red") +
    stat_smooth() +
    stat_smooth(col = "orange") +
    theme_cowplot(20)
  
  p3 <- p1 + p2
  
  save_plot(filename = paste0("output/figures/", norm_mod, "_vs_", lnorm_mod, "_pars.png"), 
            plot = p3, 
            base_height = 8, 
            base_asp = 1.618*2)
}


get_ll <- function(mod_data, species_indx, sigma, mu, meanlog, sdlog, eps_LN, eps_N){
  
  f <- c()
  l <- mod_data$l
  b <-  mod_data$b
  i_min <- mod_data$i_min
  i_max <- mod_data$i_max
  B <-  mod_data$B
  n <-  mod_data$n
  
  
  for (k in 1:B) {
    f[k] = (l[k+1] - l[k]) / (l[B+1] - l[1]);	#// calculate relative bin widths
  }
  
  ll_norm = 0
  ll_lnorm = 0
  
  norm_c_N = 1.0 - pnorm(l[1], mu, sigma); 
  norm_c_LN = 1.0 - plnorm(l[1], meanlog, sdlog); 
  
  for (j in i_min[species_indx]:i_max[species_indx]) { #// observation j
    # // probability of being in bin (prior to misclassification)
    p_N = (pnorm(l[b[j]+1], mu, sigma) - 
             pnorm(l[b[j]], mu, sigma)) / norm_c_N; 
    # // add misclassification probability (ensures non-zero p)
    p_N = (1.0 - eps_N)*p_N + eps_N*f[b[j]]; 
    
    # // probability of being in bin (prior to misclassification)
    p_LN = (plnorm(l[b[j]+1], meanlog, sdlog) - 
              plnorm(l[b[j]], meanlog, sdlog)) / norm_c_LN;
    # // add misclassification probabily (ensures non-zero p)
    p_LN = (1.0 - eps_LN)*p_LN + eps_LN*f[b[j]]; 
    
    ll_norm = ll_norm + n[j]*log(p_N) 
    ll_lnorm = ll_lnorm + n[j]*log(p_LN); 
  }
  return(tibble(ll_norm, ll_lnorm))
}




```

## Log-likelihood comparison

```{r}

if(!file.exists("output/likelihoods/mod_13_poplvl.parquet")){
  par_table <- 
    run_stanmod("mod_13_allspp") %>% 
    posterior::as_draws_df() %>% 
    mutate(draws = row_number()) %>% 
    pivot_longer(cols = -draws) %>% 
    filter(!str_detect(name, "ln")) %>% 
    mutate(species_indx = str_extract(name, "(?!\\[)\\d*(?=\\])") %>% as.numeric(),
           parameter = str_extract(name, ".*(?=\\[.*)")) %>% 
    drop_na(species_indx) %>% 
    select(-name) %>% 
    pivot_wider(names_from = parameter, 
                values_from = value) 
  
  par_table2 <- 
    par_table %>% 
    mutate(ll = pmap(.l = list(species_indx = species_indx, 
                               sigma = sigma, 
                               mu = mu, 
                               meanlog = meanlog, 
                               sdlog = sdlog,
                               eps_N = eps_N,
                               eps_LN = eps_LN), 
                     .f = get_ll,
                     mod_data = mod_13_allspp_data)) 
  
  par_table3 <- 
    par_table2 %>% 
    unnest(cols = ll) %>% 
    pivot_longer(cols = c(ll_norm, ll_lnorm), 
                 names_to = "dist", 
                 values_to = "ll") %>% 
    left_join(data_obs_count_allspp %>% 
                select(species_indx, species_name) %>% distinct()) 
  
  
  write_parquet(par_table3, "output/likelihoods/mod_13_poplvl.parquet")
}

par_table3 <- read_parquet("output/likelihoods/mod_13_poplvl.parquet")


ll_wide <- 
  par_table3 %>% 
  pivot_wider(names_from = dist, 
              values_from = ll) %>% 
  mutate(diff = ll_norm - ll_lnorm) %>% 
  summarise(norm_better = sum(diff>0)/1500, 
            .by = species_name) 

prop_better <-
  ll_wide %>% 
  ggplot() +
  aes(x = norm_better) + 
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = 0, xmax = 0.5), fill = "red", alpha = 0.5) +
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = 0.5, xmax = 1), fill = "blue", alpha = 0.5) +
  geom_density(linewidth = 2) +
  geom_rug() +
  theme_cowplot(20) +
  labs(x = "Proportion of samples where Normal is better") 


save_plot("output/figures/proportion_samples_normal.png",
          prop_better,  
          base_height = 8)



ll_wide %>% 
  mutate(group = case_when(norm_better > 0.9 ~ "Always Normal",
                           norm_better < 0.1 ~ "Always Logormal", 
                           TRUE ~ "inconclusive")) %>% 
  left_join(summarise(data_obs_count_allspp, 
                      mean_size = mean(size_class, wt = n), 
                      .by = species_name)) %>% 
  ggplot(aes(y = group, x = mean_size)) +
  geom_boxplot()


ll_wide_normalised <- 
  par_table3 %>% 
  left_join(data_obs_count_allspp_byspp) %>% 
  mutate(ll = ll/totaln_spp) %>% 
  pivot_wider(names_from = dist, 
              values_from = ll) %>% 
  mutate(diff = ll_norm - ll_lnorm) 

ll_perspp_normalised <- 
  ll_wide_normalised %>% 
  summarise(diff = median(diff), 
            ll_norm = median(ll_norm), 
            ll_lnorm = median(ll_lnorm),
            .by = species_name)

plot_ll_normalised <- 
  ll_perspp_normalised %>%
  left_join(summarise(data_obs_count_allspp, 
                      mean_size = mean(size_class, wt = n), 
                      .by = species_name)) %>% 
  left_join(ll_wide) %>% 
  ggplot() +
  aes(
    x = mean_size,
    y = diff
  ) + 
  geom_rect(aes(ymin = -Inf, ymax = 0, xmin = -Inf, xmax = Inf), fill = "red", alpha = 0.5) +
  geom_rect(aes(ymin = 0, ymax = Inf, xmin = -Inf, xmax = Inf), fill = "blue", alpha = 0.5) +
  geom_point(size = 2) +
  stat_smooth(col = "orange") +
  labs(x = "Species mean size", 
       y = "Normalised loglikelighood ratio (norm_LL_N-norm_LL_LN)") +
  theme_cowplot(20)

plot_ll_normalised_v2 <- 
  ll_perspp_normalised %>%
  left_join(summarise(data_obs_count_allspp, 
                      mean_size = mean(size_class, wt = n), 
                      .by = species_name)) %>% 
  left_join(ll_wide) %>% 
  ggplot() +
  aes(
    x = mean_size,
    y = diff,
    col = norm_better
  ) + 
  geom_point(size = 2) +
  stat_smooth(col = "orange") +
  labs(x = "Species mean size", 
       y = "Normalised loglikelighood ratio (norm_LL_N-norm_LL_LN)") +
  theme_cowplot(20)


save_plot("output/figures/normalised_ll_proof.png",
          plot_ll_normalised_v2,  
          base_height = 8)

plot_ll_normalised_v3 <- 
  ll_perspp_normalised %>%
  pivot_longer(cols = starts_with("ll_")) %>% 
  left_join(summarise(data_obs_count_allspp, 
                      mean_size = mean(size_class, wt = n), 
                      .by = species_name)) %>% 
  left_join(ll_wide) %>% 
  ggplot() +
  aes(
    x = mean_size,
    y = value,
    col = name
  ) + 
  # geom_rect(aes(ymin = -Inf, ymax = 0, xmin = -Inf, xmax = Inf), fill = "red", alpha = 0.5) +
  # geom_rect(aes(ymin = 0, ymax = Inf, xmin = -Inf, xmax = Inf), fill = "blue", alpha = 0.5) +
  geom_point(size = 2, alpha = 0.5) +
  stat_smooth() +
  labs(x = "Species mean size (cm)", 
       y = "Normalised loglikelighood") +
  theme_cowplot(20)



save_plot("output/figures/normalised_ll_bydist.png",
          plot_ll_normalised_v3,  
          base_height = 8)







ll_wide %>% 
  
  left_join(summarise(data_obs_count_allspp, 
                      mean_size = mean(size_class, wt = n), 
                      .by = species_name)) %>% 
  ggplot() + 
  aes(
    x = mean_size, 
    y = norm_better
  ) +
  geom_point() +
  stat_smooth()


ll_wide %>% 
  left_join(data_obs_count_allspp %>% select(species_name, species_indx) %>% distinct()) %>% 
  left_join(data_obs_count_allspp_byspp) %>% 
  ggplot() + 
  aes(
    x = totaln_spp %>% log(), 
    y = norm_better 
  ) +
  geom_point() +
  stat_smooth()

ll_wide %>% 
  summarise


par_table3 %>% 
  pivot_wider(names_from = dist, 
              values_from = ll) %>% 
  # arrange(species_indx) %>% 
  reframe(sum_ll_norm = sum(ll_norm), 
          sum_ll_lnorm = sum(ll_lnorm), 
          mean_ll_norm = mean(ll_norm), 
          mean_ll_lnorm = mean(ll_lnorm),
          diff = mean(ll_norm - ll_lnorm), 
          .by = species_name) %>% 
  mutate(diff2 = mean_ll_norm - mean_ll_lnorm) %>% View()
mutate(norm_better = sum_ll_norm > sum_ll_lnorm,
       norm_better2 = mean_ll_norm > mean_ll_lnorm, 
       norm_better3 = diff > 0) %>% 
  filter(norm_better != norm_better3)
count(norm_better)


ll_ratio_plot <- 
  par_table3 %>% 
  pivot_wider(names_from = dist, 
              values_from = ll) %>% 
  mutate(diff = ll_norm - ll_lnorm) %>% 
  summarise(mean_ratio = median(diff), 
            .by = species_name) %>% 
  arrange(desc(mean_ratio)) %>% 
  left_join(summarise(data_obs_count_allspp, 
                      mean_size = mean(size_class, wt = n), 
                      .by = species_name)) %>% 
  ggplot(aes(mean_size, 
             mean_ratio %>% log())) +
  geom_ribbon(aes(ymin = 0, ymax = Inf, xmin = -Inf, xmax = Inf), fill = "blue", alpha = 0.8) +
  geom_ribbon(aes(ymin = -Inf, ymax = 0, xmin = -Inf, xmax = Inf), fill = "red", alpha = 0.8) +
  geom_point(size = 2) +
  stat_smooth(col = "orange") +
  theme_cowplot(20) +
  scale_x_continuous(labels = label_number(suffix = "cm")) +
  labs(x = "Species mean size", 
       y = "Likelihood ratio median(ll_N-ll_LN)")

save_plot("output/figures/ll_ratio_plot_mod_13.png",
          ll_ratio_plot,  
          base_height = 8)

xx %>% 
  ggplot(aes(mean_ratio)) +
  geom_vline(xintercept = 1, col = "red")+
  geom_density() +
  labs(x = "LL_NORM/LL_LNORM") 

data_obs_count_allspp %>% 
  filter(species_name %in% head(xx, n = 20)$species_name) %>% 
  ggplot() +
  aes(x = size_class, 
      y = p) +
  geom_point() + 
  geom_line() +
  facet_wrap(~species_name, scales = "free")

data_obs_count_allspp %>% 
  filter(species_name %in% tail(xx, n = 20)$species_name) %>% 
  ggplot() +
  aes(x = size_class, 
      y = p) +
  geom_point() + 
  geom_line() +
  facet_wrap(~species_name, scales = "free")

ll_plots <- 
  par_table3 %>% 
  filter(species_name %in% data_obs_count_20spp$species_name) %>% 
  mutate(dist = case_when(dist == "ll_norm" ~ "Normal", 
                          dist == "ll_lnorm" ~ "Lognormal")) %>% 
  ggplot(aes(x =  dist, 
             y = ll,
             col = dist)) +
  scale_color_manual(values=c("Lognormal" = "red", 
                              "Normal" = "blue"))+
  geom_boxplot() +
  facet_wrap(~species_name, scales = "free") +
  labs(x = "", 
       y = "Loglikelihood") +
  theme(legend.position = "none")

save_plot("output/figures/ll_plots_mod_13.png",
          ll_plots,  
          base_height = 8)


```


